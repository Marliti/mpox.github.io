<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Mpox – Confirmés (barres) + Suspects (ligne) • Filtres + Zoom + Transitions + Slider</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<style>
:root{
  --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --grid:#334155;
  --confirme:#8b5cf6; --suspect:#22d3ee; --hover:#f59e0b;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
.wrap{max-width:1100px;margin:32px auto;padding:20px;background:var(--panel);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
h1{margin:0 0 8px;font-size:clamp(20px,2.4vw,28px)}
.subtitle{color:var(--muted);margin-bottom:12px}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:8px;align-items:center}
select,input[type="range"],input[type="file"]{padding:4px;border-radius:6px;border:1px solid var(--grid);background:#1e293b;color:var(--text)}
.chart{width:100%;aspect-ratio:16/9;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0))}
.axis path,.axis line{stroke:var(--grid)}
.grid line{stroke:var(--grid);stroke-opacity:.5}
.tooltip{
  position:fixed; pointer-events:none; z-index:10; background:#0b1020; border:1px solid #1f2937; color:#e5e7eb;
  padding:8px 10px; border-radius:8px; font-size:12px; box-shadow:0 6px 22px rgba(0,0,0,.35);
  transform:translate(-50%,calc(-100% - 10px)); opacity:0; transition:opacity .12s ease;
}
.legend{display:flex;gap:16px;align-items:center;margin-top:8px;color:var(--muted);font-size:13px}
.swatch{width:12px;height:12px;border-radius:3px;display:inline-block}
.note{color:var(--muted);font-size:12px;margin-top:6px}
.bar:hover{ fill: var(--hover) !important; }
.dot:hover{ fill: var(--hover) !important; }
.hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>Mpox – Cas confirmés (barres) & cas suspects (ligne)</h1>
  <div class="subtitle">Version en ligne — charge automatiquement <code>df.csv</code> (même dossier). Fallback upload si le fichier est absent.</div>
  <div class="controls">
    <label>Département :
      <select id="departementSelect"></select>
    </label>
    <label>District :
      <select id="districtSelect"></select>
    </label>
    <label>Durée transitions (ms) :
      <input type="range" id="durSlider" min="0" max="2000" step="50" value="650" />
      <span id="durVal">650</span>
    </label>
    <span id="status" style="color:var(--muted);font-size:13px">Chargement…</span>
    <!-- Fallback upload si df.csv n'est pas trouvé -->
    <label id="uploadWrap" class="hidden">CSV local :
      <input type="file" id="file" accept=".csv" />
    </label>
  </div>
  <svg class="chart"></svg>
  <div class="legend">
    <span class="swatch" style="background:var(--confirme)"></span> cas_confirmé (barres)
    <span class="swatch" style="background:var(--suspect)"></span> cas_suspect (ligne + points)
  </div>
  <div class="note">Double-clic dans le graphique pour réinitialiser le zoom.</div>
</div>
<div class="tooltip" id="tooltip"></div>

<script>
const svg = d3.select(".chart");
const statusEl = document.getElementById("status");
const departementSelect = document.getElementById("departementSelect");
const districtSelect = document.getElementById("districtSelect");
const tooltip = document.getElementById("tooltip");
const durSlider = document.getElementById("durSlider");
const durVal = document.getElementById("durVal");
const uploadWrap = document.getElementById("uploadWrap");
const fileInput = document.getElementById("file");

const margin = {top: 28, right: 30, bottom: 64, left: 64};
let DUR = +durSlider.value;
const EASE = d3.easeCubic;

let allRows = [];
let currentData = [];
let zx, xIndex; // X scales (zoomable)
let y;          // Y scale (common)

// Slider durée
durSlider.addEventListener("input", () => { DUR = +durSlider.value; durVal.textContent = DUR; });

// Responsive
function getSize(){
  const { width } = svg.node().getBoundingClientRect();
  const height = width / (16/9);
  svg.attr("viewBox", `0 0 ${width} ${height}`);
  return {W: width, H: height};
}
window.addEventListener("resize", () => drawChart(currentData, true));

// ---- Chargement hébergé : df.csv (même dossier) ----
loadHostedCSV("df.csv")
  .then(rows => { statusEl.textContent = `OK – ${rows.length} lignes`; init(rows); })
  .catch(() => {
    statusEl.textContent = "df.csv introuvable sur le site — vous pouvez charger un CSV local.";
    uploadWrap.classList.remove("hidden");
  });

// Fallback: upload local
fileInput?.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if(!file) return;
  statusEl.textContent = `Chargement local: ${file.name}…`;
  const reader = new FileReader();
  reader.onload = () => {
    const rows = d3.dsvFormat(";").parse(reader.result);
    statusEl.textContent = `Lignes: ${rows.length}`;
    init(rows);
  };
  reader.readAsText(file, "utf-8");
});

async function loadHostedCSV(path){
  // d3.dsv gère fetch + parse ; on force le cache-busting pour Pages si besoin
  return d3.dsv(";", `${path}?v=${Date.now()}`);
}

// ---- Initialisation / Filtres ----
function init(rows){
  allRows = rows;
  const deps = Array.from(new Set(allRows.map(d => d.Departements?.trim()).filter(Boolean))).sort();
  departementSelect.innerHTML = `<option value="">(Tous)</option>` + deps.map(dep => `<option>${dep}</option>`).join("");
  districtSelect.innerHTML = `<option value="">(Tous)</option>`;
  departementSelect.onchange = updateDistrictOptions;
  districtSelect.onchange = () => updateChart(false);
  updateChart(true);
}
function updateDistrictOptions(){
  const dep = departementSelect.value;
  const filtered = dep ? allRows.filter(d => (d.Departements||"").trim() === dep) : allRows;
  const dists = Array.from(new Set(filtered.map(d => d.Districts_Sanitaires?.trim()).filter(Boolean))).sort();
  districtSelect.innerHTML = `<option value="">(Tous)</option>` + dists.map(ds => `<option>${ds}</option>`).join("");
  updateChart(false);
}

function updateChart(first=false){
  let rows = allRows.map(d => ({
    ...d,
    cas_suspect: +d.cas_suspect || 0,
    cas_confirme: +d.cas_confirme || 0,
    Year_Week: (d.Year_Week || "").trim(),
    Departements: (d.Departements || "").trim(),
    Districts_Sanitaires: (d.Districts_Sanitaires || "").trim()
  }));
  if(departementSelect.value){
    rows = rows.filter(d => d.Departements === departementSelect.value);
  }
  if(districtSelect.value){
    rows = rows.filter(d => d.Districts_Sanitaires === districtSelect.value);
  }
  const grouped = d3.rollups(
    rows,
    v => ({
      cas_suspect: d3.sum(v, d => d.cas_suspect),
      cas_confirme: d3.sum(v, d => d.cas_confirme)
    }),
    d => d.Year_Week
  ).map(([k, v]) => ({Year_Week: k, ...v}))
   .filter(d => d.Year_Week);

  grouped.sort((a,b) => {
    const pa = parseYW(a.Year_Week), pb = parseYW(b.Year_Week);
    return pa.year - pb.year || pa.week - pb.week;
  });

  currentData = grouped;
  drawChart(grouped, first);
}

// ---- Dessin + Zoom + Transitions ----
function drawChart(data, first=false){
  svg.selectAll("*").remove();
  const {W, H} = getSize();
  const innerW = W - margin.left - margin.right;
  const innerH = H - margin.top - margin.bottom;

  const root = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  // Échelles
  y = d3.scaleLinear()
    .domain([0, d3.max(data, d => Math.max(d.cas_confirme, d.cas_suspect)) || 1]).nice()
    .range([innerH, 0]);
  const n = data.length;
  xIndex = d3.scaleLinear().domain([0, n]).range([0, innerW]);
  zx = xIndex.copy();

  const baseBarPad = 0.88;
  const barX = (i) => zx(i);
  const barW = (i) => Math.max(1, Math.abs(zx(i+1) - zx(i)) * baseBarPad);
  const barCenter = (i) => zx(i) + barW(i)/2;

  // Grille
  root.append("g").attr("class","grid")
    .call(d3.axisLeft(y).ticks(6).tickSize(-innerW).tickFormat(""))
    .selectAll("line").attr("opacity", .6);

  // Calques
  const overlayG = root.append("g");
  const barsG   = root.append("g");
  const lineG   = root.append("g");
  const dotsG   = root.append("g");
  const axisXG  = root.append("g").attr("transform", `translate(0,${innerH})`);
  const axisYG  = root.append("g");

  // Barres confirmés
  const bars = barsG.selectAll("rect").data(data, d => d.Year_Week);
  bars.join(
    enter => enter.append("rect")
      .attr("class","bar")
      .attr("fill","var(--confirme)")
      .attr("x", (d,i) => barX(i) + (Math.abs(zx(i+1)-zx(i)) - barW(i))/2)
      .attr("width", (d,i) => barW(i))
      .attr("y", y(0)).attr("height", 0)
      .on("mouseenter", (evt, d) => showTip(d))
      .on("mouseleave", hideTip)
      .on("mousemove", moveTip)
      .call(enter => enter.transition().duration(first?0:DUR).ease(EASE)
        .attr("y", d => y(d.cas_confirme))
        .attr("height", d => y(0) - y(d.cas_confirme))
      ),
    update => update
      .on("mouseenter", (evt, d) => showTip(d))
      .on("mouseleave", hideTip)
      .on("mousemove", moveTip)
      .call(update => update.transition().duration(first?0:DUR).ease(EASE)
        .attr("x", (d,i) => barX(i) + (Math.abs(zx(i+1)-zx(i)) - barW(i))/2)
        .attr("width", (d,i) => barW(i))
        .attr("y", d => y(d.cas_confirme))
        .attr("height", d => y(0) - y(d.cas_confirme))
      ),
    exit => exit.call(exit => exit.transition().duration(Math.max(150, DUR/1.3)).ease(EASE)
        .attr("y", y(0)).attr("height", 0).style("opacity", 0).remove()
      )
  );

  // Ligne suspects
  const lineGen = d3.line()
    .x((d, i) => barCenter(i))
    .y(d => y(d.cas_suspect))
    .curve(d3.curveMonotoneX);

  const path = lineG.append("path")
    .datum(data)
    .attr("fill","none")
    .attr("stroke","var(--suspect)")
    .attr("stroke-width",2);

  const oldD = path.attr("d") || lineGen(data);
  const newD = lineGen(data);
  path.attr("d", oldD)
      .transition().duration(first?0:DUR).ease(EASE)
      .attrTween("d", () => {
        const i = d3.interpolateString(oldD, newD);
        return t => i(t);
      });

  // Points suspects
  const dots = dotsG.selectAll("circle").data(data, d => d.Year_Week);
  dots.join(
    enter => enter.append("circle")
      .attr("class","dot")
      .attr("r", 0).attr("fill","var(--suspect)")
      .attr("cx", (d,i) => barCenter(i)).attr("cy", d => y(d.cas_suspect))
      .on("mouseenter", (evt, d) => showTip(d, true))
      .on("mouseleave", hideTip)
      .on("mousemove", moveTip)
      .call(enter => enter.transition().duration(first?0:DUR).ease(EASE)
        .attr("r", 3).style("opacity", 1)
      ),
    update => update
      .on("mouseenter", (evt, d) => showTip(d, true))
      .on("mouseleave", hideTip)
      .on("mousemove", moveTip)
      .call(update => update.transition().duration(first?0:DUR).ease(EASE)
        .attr("cx", (d,i) => barCenter(i))
        .attr("cy", d => y(d.cas_suspect))
        .style("opacity", 1)
      ),
    exit => exit.call(exit => exit.transition().duration(Math.max(150, DUR/1.3)).ease(EASE)
        .attr("r", 0).style("opacity", 0).remove()
      )
  );

  // Axes
  axisYG.call(d3.axisLeft(y).ticks(6));
  updateAxisXTicks();

  // Titres axes
  svg.append("text")
    .attr("transform", `rotate(-90)`)
    .attr("y", 18)
    .attr("x", -(H/2))
    .attr("dy", "1em")
    .style("text-anchor", "middle")
    .style("fill", "var(--text)")
    .text("Nombre de cas");
  svg.append("text")
    .attr("transform", `translate(${(W/2)}, ${H - 10})`)
    .style("text-anchor", "middle")
    .style("fill", "var(--text)")
    .text("Semaine épidémiologique (Year_Week)");

  // Rendu positions (pour zoom)
  function renderOnlyPositions(){
    barsG.selectAll("rect")
      .attr("x", (d,i) => barX(i) + (Math.abs(zx(i+1)-zx(i)) - barW(i))/2)
      .attr("width", (d,i) => barW(i));
    lineG.selectAll("path").attr("d", lineGen);
    dotsG.selectAll("circle")
      .attr("cx", (d,i) => barCenter(i))
      .attr("cy", d => y(d.cas_suspect));
    updateAxisXTicks();
  }

  // Axe X dynamique
  function updateAxisXTicks(){
    const visStart = Math.max(0, Math.floor(zx.invert(0)));
    const visEnd = Math.min(n, Math.ceil(zx.invert(innerW)));
    const visible = data.slice(visStart, visEnd).map((d, i) => ({idx: visStart + i, label: d.Year_Week}));
    const maxTicks = 16;
    const step = Math.max(1, Math.ceil(visible.length / maxTicks));
    const ticks = visible.filter((_,i) => i % step === 0);
    axisXG.call(
      d3.axisBottom(d3.scaleLinear().domain([0, innerW]).range([0, innerW]))
        .tickValues(ticks.map(t => zx(t.idx)))
        .tickFormat((_, i) => ticks[i]?.label ?? "")
    )
    .selectAll("text").attr("transform","rotate(-35)").style("text-anchor","end");
  }

  // Zoom / Pan
  const zoom = d3.zoom()
    .scaleExtent([1, 20])
    .translateExtent([[0,0],[innerW,innerH]])
    .extent([[0,0],[innerW,innerH]])
    .on("zoom", (event) => { zx = event.transform.rescaleX(xIndex); renderOnlyPositions(); });

  const overlay = overlayG.append("rect")
    .attr("width", innerW)
    .attr("height", innerH)
    .attr("fill","transparent")
    .style("cursor","grab");
  overlay.lower();
  svg.call(zoom);
  overlay.on("dblclick", () => svg.transition().duration(250).call(zoom.transform, d3.zoomIdentity));

  // Infobulles
  function showTip(d){
    const total = d.cas_confirme + d.cas_suspect;
    tooltip.innerHTML = `<strong>${d.Year_Week}</strong><br/>confirmés : <b>${d.cas_confirme}</b><br/>suspects : <b>${d.cas_suspect}</b><br/>total : <b>${total}</b>`;
    tooltip.style.opacity = 1;
  }
  function moveTip(e){ tooltip.style.left = e.clientX + "px"; tooltip.style.top = e.clientY + "px"; }
  function hideTip(){ tooltip.style.opacity = 0; }
}

// Helpers
function parseYW(s){ const m = /(\d{4})\D+(\d+)/.exec(s||""); return {year: m? +m[1]:0, week: m? +m[2]:0}; }
</script>
</body>
</html>
